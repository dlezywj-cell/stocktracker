<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行业强弱追踪(调试模式)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f5f5f7; margin: 0; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        #debug-log { 
            background: #333; color: #0f0; font-family: monospace; 
            padding: 10px; border-radius: 8px; font-size: 12px; 
            height: 200px; overflow-y: scroll; white-space: pre-wrap;
            margin-bottom: 10px;
        }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        #chart-container { height: 400px; width: 100%; border: 1px dashed #ddd; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>

<div class="card">
    <h3>调试日志 (请截图这里)</h3>
    <div id="debug-log">等待加载...</div>
    <button onclick="fetchData()" style="padding:8px 16px;background:#007aff;color:white;border:none;border-radius:6px;">手动刷新数据</button>
</div>

<div class="card">
    <div class="controls">
        <input type="date" id="startDate" onchange="renderChart()">
        <span>至</span>
        <input type="date" id="endDate" onchange="renderChart()">
        <button onclick="renderChart()">重绘</button>
    </div>
</div>

<div class="card">
    <div id="chart-container"></div>
</div>

<script>
    // 简单的日志工具，把信息打印在屏幕上
    function log(msg, isError = false) {
        const box = document.getElementById('debug-log');
        const line = document.createElement('div');
        line.style.color = isError ? '#ff4d4f' : '#0f0';
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        box.appendChild(line);
        box.scrollTop = box.scrollHeight;
        console.log(msg);
    }

    let rawData = null; 
    let myChart = null;

    // 初始化日期
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    document.getElementById('endDate').valueAsDate = end;
    document.getElementById('startDate').valueAsDate = start;

    async function fetchData() {
        log("开始请求 industry_data.json...");
        
        try {
            // 加上时间戳防止缓存
            const response = await fetch('industry_data.json?t=' + new Date().getTime());
            
            log(`网络状态码: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`文件请求失败 (404/403/500)`);
            }
            
            const text = await response.text();
            log(`文件长度: ${text.length} 字符`);
            
            if (text.length < 50) {
                log(`警告：文件内容太短: ${text}`, true);
                throw new Error("数据文件看起来是空的或内容不对");
            }

            try {
                rawData = JSON.parse(text);
                log("JSON 解析成功！");
            } catch (e) {
                throw new Error("JSON 格式错误，无法解析");
            }

            // 检查数据结构
            if (!rawData.dates || !Array.isArray(rawData.dates)) {
                throw new Error("数据缺少 dates 字段或格式不对");
            }
            log(`包含日期数: ${rawData.dates.length} 天`);
            log(`数据日期示例: ${rawData.dates[0]} ~ ${rawData.dates[rawData.dates.length-1]}`);
            
            if (!rawData.data) throw new Error("数据缺少 data 字段");
            const keys = Object.keys(rawData.data);
            log(`包含行业数: ${keys.length} 个`);
            log(`行业示例: ${keys[0]}, 数据点: ${rawData.data[keys[0]].length}`);

            renderChart();
            
        } catch (error) {
            log(`致命错误: ${error.message}`, true);
        }
    }

    function renderChart() {
        if (!rawData) {
            log("没有数据，无法绘图", true);
            return;
        }

        try {
            const sDate = document.getElementById('startDate').value;
            const eDate = document.getElementById('endDate').value;
            log(`尝试绘图区间: ${sDate} 到 ${eDate}`);

            // 查找索引
            let sIdx = rawData.dates.findIndex(d => d >= sDate);
            // 如果找不到（比如选的太早），就从0开始
            if (sIdx === -1 && rawData.dates[0] > sDate) sIdx = 0;
            
            let eIdx = rawData.dates.findIndex(d => d > eDate);
            if (eIdx === -1) eIdx = rawData.dates.length;

            log(`计算出的索引: Start=${sIdx}, End=${eIdx}`);

            if (sIdx >= eIdx) {
                log("警告: 选定的时间内没有数据点 (Start >= End)", true);
                return;
            }

            // 准备数据
            const series = [];
            const slicedDates = rawData.dates.slice(sIdx, eIdx);
            
            // 简单的取前10个行业画图测试
            const keys = Object.keys(rawData.data).slice(0, 10);
            
            keys.forEach(name => {
                const prices = rawData.data[name];
                if(prices && prices.length > sIdx) {
                    const subset = prices.slice(sIdx, eIdx);
                    // 归一化
                    const base = subset[0];
                    if(base) {
                        const norm = subset.map(p => (p/base).toFixed(4));
                        series.push({
                            name: name,
                            type: 'line',
                            data: norm,
                            showSymbol: false
                        });
                    }
                }
            });

            log(`生成了 ${series.length} 条曲线数据`);

            if (!myChart) myChart = echarts.init(document.getElementById('chart-container'));
            
            const option = {
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: slicedDates },
                yAxis: { type: 'value', scale:true },
                series: series
            };
            
            myChart.setOption(option, true);
            log("图表绘制命令已发送");

        } catch (e) {
            log(`绘图过程报错: ${e.message}`, true);
            console.error(e);
        }
    }

    // 启动
    fetchData();

    window.addEventListener('resize', () => myChart && myChart.resize());
</script>
</body>
</html>
