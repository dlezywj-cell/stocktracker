<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è¡Œä¸šå¼ºå¼±è¿½è¸ª (è°ƒè¯•ç‰ˆ)</title>
    <!-- ä½¿ç”¨ç¨³å®šçš„ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #f5f5f7; --card: #ffffff; --text-main: #1d1d1f; --text-sec: #86868b; --primary: #007aff; --success: #34c759; --danger: #ff3b30; --radius: 12px; }
        html, body { height: 100%; width: 100%; overflow: hidden; position: fixed; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; flex-direction: column; }
        
        /* å¸ƒå±€æ ·å¼ */
        header { background: #fff; height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; border-bottom: 1px solid #e5e5e5; flex-shrink: 0; }
        .app-title { font-weight: 700; font-size: 15px; }
        .sync-info { font-size: 11px; color: var(--text-sec); display: flex; align-items: center; gap: 4px; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .sync-dot.online { background: var(--success); }
        .sync-dot.error { background: var(--danger); }
        
        .control-panel { background: var(--bg); padding: 8px 12px; flex-shrink: 0; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid #e5e5e5; }
        .control-row { display: flex; align-items: center; gap: 10px; overflow-x: auto; }
        .input-group { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-sec); flex-shrink: 0; }
        .date-inp { border: 1px solid #e5e5e5; background: #fff; padding: 4px; border-radius: 6px; font-size: 12px; width: 105px; text-align: center; }
        .btn-icon { background: var(--primary); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer;}
        .btn-save { background: var(--success); color: white; border: none; padding: 0 12px; height: 28px; border-radius: 14px; font-size: 12px; margin-left: auto; display: none; align-items: center; gap: 5px; }
        
        .group-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 2px; }
        .group-chip { padding: 4px 12px; border-radius: 14px; font-size: 12px; background: #fff; border: 1px solid #e5e5e5; white-space: nowrap; cursor: pointer; color: #666; }
        .group-chip.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .workspace { flex: 1; display: flex; gap: 10px; padding: 10px; overflow: hidden; position: relative; }
        .chart-wrapper { flex: 1; background: #fff; border-radius: 12px; position: relative; display: flex; flex-direction: column; }
        #chart-container { width: 100%; height: 100%; }
        .list-wrapper { width: 240px; background: #fff; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .list-body { flex: 1; overflow-y: auto; padding: 5px; }
        .list-item { padding: 8px; border-bottom: 1px solid #f5f5f5; font-size: 12px; display: flex; justify-content: space-between; cursor: pointer; }
        .list-item.active-state { background: #eef6ff; font-weight: bold; border-left: 3px solid var(--primary); }
        .list-item.dimmed { opacity: 0.4; }

        /* --- è°ƒè¯•æ§åˆ¶å°æ ·å¼ --- */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace;
            font-size: 11px; padding: 10px; box-sizing: border-box;
            overflow-y: auto; z-index: 9999; border-top: 2px solid #333;
            display: block; /* é»˜è®¤æ˜¾ç¤º */
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-err { color: #ff4d4d; font-weight: bold; background: rgba(255,0,0,0.1); }
        .log-warn { color: #ffd700; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: #fff; width: 80%; padding: 20px; border-radius: 12px; }
        .form-input { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;}
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 10px; border: none; border-radius: 6px; }

        @media (max-width: 768px) {
            .workspace { flex-direction: column; padding: 0; }
            .chart-wrapper { flex: 0 0 50%; border-radius: 0; }
            .list-wrapper { width: 100%; flex: 1; border-radius: 0; }
            #debug-console { height: 150px; }
        }
    </style>
</head>
<body>

<header>
    <div class="app-title">è¡Œä¸šå¼ºå¼± (è°ƒè¯•æ¨¡å¼)</div>
    <div class="sync-info">
        <div id="syncDot" class="sync-dot"></div>
        <span id="updateTime">åˆå§‹åŒ–...</span>
        <button onclick="openSettings()" style="border:none;background:none;font-size:16px;">âš™ï¸</button>
    </div>
</header>

<div class="control-panel">
    <div class="control-row">
        <div class="input-group">
            <input type="date" id="startDate" class="date-inp" onchange="handleInputChange()">
            -
            <input type="date" id="endDate" class="date-inp" onchange="handleInputChange()">
        </div>
        <button class="btn-icon" onclick="fetchData()">ğŸ”„</button>
        <button id="saveGroupBtn" class="btn-save" onclick="saveCurrentSelection()">ğŸ’¾ ä¿å­˜</button>
    </div>
    <div class="group-tabs" id="groupTabs"></div>
</div>

<div class="workspace">
    <div class="chart-wrapper">
        <div id="chart-container"></div>
    </div>
    <div class="list-wrapper">
        <div class="list-body" id="rankList"></div>
    </div>
</div>

<!-- è°ƒè¯•æ§åˆ¶å° -->
<div id="debug-console">
    <div style="color:#fff;border-bottom:1px solid #666;margin-bottom:5px;">
        DEBUG CONSOLE (è¯·æˆªå›¾çº¢è‰²æŠ¥é”™ä¿¡æ¯) 
        <button onclick="document.getElementById('debug-console').style.display='none'" style="float:right;font-size:10px;">å…³é—­</button>
    </div>
    <div id="debug-logs"></div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal-overlay" id="settingModal">
    <div class="modal-card">
        <h3>GitHub é…ç½®</h3>
        <input type="text" id="cfgOwner" class="form-input" placeholder="ç”¨æˆ·å (Owner)">
        <input type="text" id="cfgRepo" class="form-input" placeholder="ä»“åº“å (Repo)">
        <input type="password" id="cfgToken" class="form-input" placeholder="Token (ghp_...)">
        <div class="modal-btns">
            <button style="background:#eee" onclick="closeSettings()">å–æ¶ˆ</button>
            <button style="background:var(--primary);color:#fff" onclick="saveSettings()">ä¿å­˜å¹¶é‡è¯•</button>
        </div>
    </div>
</div>

<script>
    // --- è°ƒè¯•å·¥å…· ---
    function log(msg, type='info') {
        const consoleDiv = document.getElementById('debug-logs');
        const line = document.createElement('div');
        line.className = 'log-line ' + (type === 'error' ? 'log-err' : (type === 'warn' ? 'log-warn' : ''));
        const time = new Date().toLocaleTimeString();
        line.textContent = `[${time}] ${msg}`;
        consoleDiv.appendChild(line);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(msg); // åŒæ—¶ä¹Ÿæ‰“åˆ°æµè§ˆå™¨æ§åˆ¶å°
    }
    window.onerror = function(msg, url, line) {
        log(`å…¨å±€é”™è¯¯: ${msg} (Line: ${line})`, 'error');
    };

    // --- é…ç½® ---
    let CONFIG = { owner: '', repo: '', path: 'groups.json', token: '' };
    
    function loadConfig() {
        CONFIG.owner = localStorage.getItem('gh_owner') || 'dlezywj-cell';
        CONFIG.repo = localStorage.getItem('gh_repo') || 'stocktracker';
        CONFIG.token = localStorage.getItem('gh_token') || '';
        
        document.getElementById('cfgOwner').value = CONFIG.owner;
        document.getElementById('cfgRepo').value = CONFIG.repo;
        document.getElementById('cfgToken').value = CONFIG.token;
        log(`é…ç½®åŠ è½½å®Œæ¯•: Owner=${CONFIG.owner}, Repo=${CONFIG.repo}, Token=${CONFIG.token ? 'å·²å¡«å†™(éšè—)' : 'æœªå¡«å†™'}`);
    }

    function openSettings() { document.getElementById('settingModal').classList.add('active'); }
    function closeSettings() { document.getElementById('settingModal').classList.remove('active'); }
    function saveSettings() {
        const o = document.getElementById('cfgOwner').value.trim();
        const r = document.getElementById('cfgRepo').value.trim();
        const t = document.getElementById('cfgToken').value.trim();
        if(!o || !r) return alert("ç”¨æˆ·åå’Œä»“åº“åå¿…å¡«");
        localStorage.setItem('gh_owner', o);
        localStorage.setItem('gh_repo', r);
        localStorage.setItem('gh_token', t);
        loadConfig();
        closeSettings();
        fetchData();
    }

    // --- å…¨å±€å˜é‡ ---
    let rawData = null, groupsData = {}, myChart = null;
    let selectedSeries = new Set(), globalDates = [], activeMode = 'RANKING', activeGroupName = null;

    // --- æ ¸å¿ƒé€»è¾‘ï¼šå¸¦è¯¦ç»†è°ƒè¯•çš„ Fetch ---
    async function fetchData() {
        log("å¼€å§‹ fetchData...");
        const dot = document.getElementById('syncDot');
        const timeTxt = document.getElementById('updateTime');
        dot.className = 'sync-dot';
        dot.style.background = 'orange';
        timeTxt.innerText = 'åŠ è½½ä¸­...';

        try {
            // 1. åŠ è½½è¡Œæƒ…æ•°æ®
            log("æ­¥éª¤1: è¯·æ±‚ industry_data.json");
            const res = await fetch('industry_data.json?t=' + Date.now());
            if(!res.ok) throw new Error(`è¡Œæƒ…æ–‡ä»¶è¯·æ±‚å¤±è´¥: ${res.status} ${res.statusText}`);
            
            try {
                rawData = await res.json();
                log(`è¡Œæƒ…æ•°æ®è§£ææˆåŠŸ: åŒ…å« ${rawData.dates?.length} å¤©æ•°æ®`);
            } catch(e) {
                throw new Error("industry_data.json æ ¼å¼é”™è¯¯: " + e.message);
            }
            globalDates = rawData.dates;

            // 2. åŠ è½½æ¿å—æ•°æ® (GitHub)
            log("æ­¥éª¤2: è¯·æ±‚æ¿å—æ•°æ® (groups.json)");
            groupsData = {}; // é‡ç½®
            
            if (CONFIG.token && CONFIG.owner && CONFIG.repo) {
                const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
                log(`å°è¯•è¿æ¥ GitHub API: ${url}`);
                
                const ghRes = await fetch(url, {
                    headers: { 
                        'Authorization': `Bearer ${CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    cache: 'no-store'
                });

                log(`GitHub å“åº”çŠ¶æ€ç : ${ghRes.status}`);

                if (ghRes.ok) {
                    const json = await ghRes.json();
                    try {
                        const content = decodeURIComponent(escape(window.atob(json.content)));
                        groupsData = JSON.parse(content);
                        log("âœ… GitHub æ¿å—æ•°æ®åŠ è½½æˆåŠŸ");
                    } catch(e) {
                        log("âš ï¸ Base64è§£ç æˆ–JSONè§£æå¤±è´¥: " + e.message, 'warn');
                    }
                } else if (ghRes.status === 404) {
                    log("â„¹ï¸ groups.json ä¸å­˜åœ¨ (å°šæœªåˆ›å»º)ï¼Œè¿™æ˜¯æ­£å¸¸çš„", 'warn');
                } else if (ghRes.status === 401) {
                    log("âŒ 401 Unauthorized: Token æ— æ•ˆæˆ–è¿‡æœŸï¼è¯·æ£€æŸ¥è®¾ç½®ã€‚", 'error');
                } else if (ghRes.status === 403) {
                    log("âŒ 403 Forbidden: æƒé™ä¸è¶³æˆ– API é€Ÿç‡é™åˆ¶ã€‚", 'error');
                } else {
                    const errText = await ghRes.text();
                    log(`âŒ GitHub æœªçŸ¥é”™è¯¯: ${ghRes.status} - ${errText}`, 'error');
                }
            } else {
                log("âš ï¸ æœªé…ç½® Tokenï¼Œè·³è¿‡ GitHub APIï¼Œå°è¯•è¯»å–æœ¬åœ°ç¼“å­˜/æ–‡ä»¶...", 'warn');
                try {
                    const localRes = await fetch('groups.json?t=' + Date.now());
                    if(localRes.ok) {
                        groupsData = await localRes.json();
                        log("âœ… æœ¬åœ° groups.json è¯»å–æˆåŠŸ");
                    }
                } catch(e) { log("æœ¬åœ°æ–‡ä»¶è¯»å–ä¹Ÿå¤±è´¥äº† (å¿½ç•¥)"); }
            }

            dot.className = 'sync-dot online';
            dot.style.background = 'var(--success)';
            timeTxt.innerText = "å°±ç»ª";
            
            renderTabs();
            calcAndRender(true);

        } catch (err) {
            log("ğŸš¨ è‡´å‘½é”™è¯¯ä¸­æ­¢: " + err.message, 'error');
            dot.className = 'sync-dot error';
            timeTxt.innerText = "å‡ºé”™";
            alert("å‘ç”Ÿé”™è¯¯ï¼Œè¯·çœ‹åº•éƒ¨é»‘è‰²æ§åˆ¶å°çš„çº¢å­—:\n" + err.message);
        }
    }

    // --- ä¿å­˜åŠŸèƒ½ (è°ƒè¯•ç‰ˆ) ---
    async function saveCurrentSelection() {
        if(selectedSeries.size === 0) return;
        if(!CONFIG.token) { alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™ Token"); return; }
        
        const name = prompt("è¾“å…¥æ¿å—åç§°:");
        if(!name) return;
        
        log(`å¼€å§‹ä¿å­˜æ¿å—: ${name}`);
        const btn = document.getElementById('saveGroupBtn');
        btn.disabled = true;
        btn.innerText = "ä¿å­˜ä¸­...";

        try {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
            
            // 1. Get SHA
            let sha = null;
            let currentContent = {};
            log("æ­£åœ¨è·å–æ–‡ä»¶ SHA...");
            
            const getRes = await fetch(url, {
                headers: { 'Authorization': `Bearer ${CONFIG.token}` }, cache: 'no-store'
            });
            
            if(getRes.ok) {
                const data = await getRes.json();
                sha = data.sha;
                try { currentContent = JSON.parse(decodeURIComponent(escape(window.atob(data.content)))); } catch(e){}
                log(`è·å–æˆåŠŸ, SHA: ${sha}`);
            } else if (getRes.status === 404) {
                log("æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†æ–°å»ºæ–‡ä»¶");
            } else {
                throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${getRes.status}`);
            }

            // 2. Put
            currentContent[name] = Array.from(selectedSeries);
            const contentStr = JSON.stringify(currentContent, null, 2);
            const b64 = window.btoa(unescape(encodeURIComponent(contentStr)));
            
            log("æ­£åœ¨ä¸Šä¼ æ–°å†…å®¹...");
            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${CONFIG.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Update group ${name}`,
                    content: b64,
                    sha: sha
                })
            });

            if(!putRes.ok) {
                const errTxt = await putRes.text();
                throw new Error(`ä¸Šä¼ å¤±è´¥ ${putRes.status}: ${errTxt}`);
            }

            log("âœ… ä¿å­˜æˆåŠŸ!");
            alert("ä¿å­˜æˆåŠŸ");
            selectedSeries.clear();
            fetchData();

        } catch(e) {
            log("âŒ ä¿å­˜æµç¨‹å¤±è´¥: " + e.message, 'error');
            alert("ä¿å­˜å¤±è´¥: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "ğŸ’¾ ä¿å­˜";
        }
    }

    // --- æ¸²æŸ“é€»è¾‘ (ç®€åŒ–ç‰ˆï¼Œä»…ä¿è¯èƒ½è·‘é€š) ---
    function renderTabs() {
        const div = document.getElementById('groupTabs');
        let html = `<div class="group-chip ${activeMode==='RANKING'?'active':''}" onclick="switchMode('RANKING')">ğŸ† æ’å</div>`;
        Object.keys(groupsData).forEach(k => {
            html += `<div class="group-chip ${activeMode==='GROUP'&&activeGroupName===k?'active':''}" onclick="switchMode('GROUP','${k}')">${k}</div>`;
        });
        div.innerHTML = html;
    }

    function switchMode(mode, name) {
        activeMode = mode;
        activeGroupName = name;
        renderTabs();
        calcAndRender(false);
    }

    function calcAndRender(init) {
        if(!rawData) return;
        selectedSeries.clear();
        updateUI();
        
        let targetNames = activeMode === 'RANKING' ? Object.keys(rawData.data) : (groupsData[activeGroupName] || []);
        let list = [];
        
        // ç®€å•è®¡ç®—åŒºé—´æ¶¨è·Œå¹…
        const sDate = document.getElementById('startDate').value;
        const eDate = document.getElementById('endDate').value;
        let sIdx = globalDates.findIndex(d=>d>=sDate); if(sIdx<0) sIdx=0;
        let eIdx = globalDates.findIndex(d=>d>eDate); if(eIdx<0) eIdx=globalDates.length;
        
        targetNames.forEach(name => {
            const arr = rawData.data[name];
            if(!arr) return;
            const v1 = arr[sIdx] || arr.find((v,i)=>i>sIdx && v);
            const v2 = arr[Math.min(arr.length-1, eIdx-1)];
            if(v1 && v2) {
                list.push({ name, pct: (v2-v1)/v1, data: arr });
            }
        });

        list.sort((a,b) => b.pct - a.pct);
        if(activeMode === 'RANKING') list = list.slice(0, 10);
        
        renderChart(list, sIdx, eIdx, init);
        renderList(list);
    }

    function renderChart(data, sIdx, eIdx, init) {
        if(!myChart) myChart = echarts.init(document.getElementById('chart-container'));
        const series = data.map((item, i) => ({
            name: item.name, type: 'line', showSymbol: false, smooth:true,
            data: item.data.map((v, idx) => idx < sIdx ? null : (v / (item.data[sIdx]||v))),
            lineStyle: { width: 2 }, z: 2
        }));
        
        const opt = {
            animation: false,
            grid: { left:40, right:10, top:20, bottom:30 },
            xAxis: { type: 'category', data: globalDates },
            yAxis: { type: 'value', scale:true, axisLabel:{formatter:v=>((v-1)*100).toFixed(0)+'%'} },
            dataZoom: [{ type:'slider', startValue: sIdx, endValue: eIdx, show:true }],
            tooltip: { trigger:'axis', formatter: p => {
                let s = p[0].axisValue + '<br>';
                p.sort((a,b)=>b.value-a.value);
                p.forEach(x => s+=`${x.marker}${x.seriesName}: ${((x.value-1)*100).toFixed(2)}%<br>`);
                return s;
            }},
            series: series
        };
        myChart.setOption(opt, true); 
        myChart.off('click');
        myChart.on('click', params => {
            if(params.componentType === 'series') toggleSel(params.seriesName);
        });
    }

    function renderList(data) {
        const div = document.getElementById('rankList');
        div.innerHTML = data.map(d => `
            <div class="list-item ${selectedSeries.has(d.name)?'active-state':''}" onclick="toggleSel('${d.name}')">
                <span>${d.name}</span>
                <span style="color:${d.pct>=0?'#ff3b30':'#34c759'}">${(d.pct*100).toFixed(2)}%</span>
            </div>
        `).join('');
    }

    function toggleSel(name) {
        if(selectedSeries.has(name)) selectedSeries.delete(name);
        else selectedSeries.add(name);
        updateUI();
    }

    function updateUI() {
        document.getElementById('saveGroupBtn').style.display = selectedSeries.size > 0 ? 'flex' : 'none';
        // ç®€å•é‡ç»˜åˆ—è¡¨é«˜äº®
        document.querySelectorAll('.list-item').forEach(el => {
            const txt = el.querySelector('span').innerText;
            if(selectedSeries.has(txt)) el.classList.add('active-state');
            else el.classList.remove('active-state');
        });
        // å›¾è¡¨é«˜äº®é€»è¾‘ç®€åŒ–
        if(myChart) {
            const op = myChart.getOption();
            op.series.forEach(s => {
                const isSel = selectedSeries.has(s.name);
                const hasAny = selectedSeries.size > 0;
                s.lineStyle.opacity = hasAny ? (isSel ? 1 : 0.2) : 1;
                s.lineStyle.width = isSel ? 3 : (hasAny ? 1 : 2);
                s.z = isSel ? 10 : 2;
            });
            myChart.setOption(op);
        }
    }

    function handleInputChange() { calcAndRender(false); }

    // åˆå§‹åŒ–
    loadConfig();
    const now = new Date();
    document.getElementById('endDate').valueAsDate = now;
    const prev = new Date(); prev.setDate(now.getDate()-30);
    document.getElementById('startDate').valueAsDate = prev;
    
    // å¯åŠ¨
    fetchData();

</script>
</body>
</html>
